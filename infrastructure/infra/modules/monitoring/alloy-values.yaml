alloy:
  configMap:
    create: true
    content: |
      // 1. Discover all pods in the cluster
      discovery.kubernetes "all_pods" {
        role = "pod"
      }

      // 2. Map metadata to clean labels
      discovery.relabel "local_pods" {
        targets = discovery.kubernetes.all_pods.targets

        // Map namespace
        rule {
          source_labels = ["__meta_kubernetes_namespace"]
          target_label  = "namespace"
        }

        // Map pod name
        rule {
          source_labels = ["__meta_kubernetes_pod_name"]
          target_label  = "pod"
        }

        // Map container name
        rule {
          source_labels = ["__meta_kubernetes_pod_container_name"]
          target_label  = "container"
        }

        // Map 'app' label (Standard)
        rule {
          source_labels = ["__meta_kubernetes_pod_label_app"]
          target_label  = "app"
        }

        // Map 'app.kubernetes.io/name' label if 'app' is not set
        rule {
          source_labels = ["__meta_kubernetes_pod_label_app_kubernetes_io_name"]
          target_label  = "app"
          // This only applies if 'app' wasn't already set by the previous rule
          action = "replace"
        }
      }

      // 3. Collect logs via Kubernetes API
      loki.source.kubernetes "pod_logs" {
        targets    = discovery.relabel.local_pods.output
        forward_to = [loki.write.loki_endpoint.receiver]
      }

      // 4. Send logs to Loki
      loki.write "loki_endpoint" {
        endpoint {
          url = "http://loki-gateway/loki/api/v1/push"
        }
      }

controller:
  type: daemonset